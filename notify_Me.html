<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="CCSICTLOGOCROP.png">
    <title>Notify Me</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style type="text/tailwindcss">
        @layer utilities {
            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateY(-30px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            .animate-slideIn {
                animation: slideIn 0.5s ease-out;
            }
            
            .form-group {
                margin-bottom: 20px;
                opacity: 1;
                max-height: 200px;
                overflow: hidden;
                transition: all 0.4s ease;
            }
            
            .form-group.hidden {
                opacity: 0;
                max-height: 0;
                margin-bottom: 0;
                pointer-events: none;
            }
            
            .option-btn.active {
                background: #ffa31a;
                border-color: #ffa31a;
                color: #000;
            }
            
            input.error {
                border-color: #ff4444;
            }
            
            .error-message {
                display: none;
            }
            
            .error-message.show {
                display: block;
            }
            
            .success-message.show {
                display: block;
            }
            
            .error-alert.show {
                display: block;
            }
        }
    </style>
</head>
<body class="font-['Segoe_UI',Tahoma,Geneva,Verdana,sans-serif] bg-[#1b1b1b] min-h-screen flex justify-center items-center p-5">
    <div class="container bg-black p-[30px_20px] sm:p-10 rounded-xl w-full max-w-[450px] animate-slideIn border border-[#2a2a2a]">
        <!-- Return to Dashboard Link -->
        <a href="student_Dashboard.html" class="inline-flex items-center text-[#ffa31a] hover:text-[#ff9500] font-medium text-sm mb-5 transition-colors duration-300">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Return to Dashboard
        </a>

        <h1 class="text-center text-[#ffa31a] mb-2.5 text-2xl sm:text-[28px] font-bold">Notify Me</h1>
        <p class="subtitle text-center text-[#999] mb-[30px] text-sm">Stay updated with our latest notifications</p>
        
        <form id="notifyForm">
            <div class="option-group mb-[25px]">
                <label class="block mb-2 text-[#ccc] font-semibold text-sm">Choose an option:</label>
                <div class="option-buttons flex flex-col sm:flex-row gap-3 mt-2.5">
                    <div class="option-btn flex-1 py-3 px-3 bg-[#1b1b1b] border-2 border-[#2a2a2a] rounded-lg cursor-pointer transition-all duration-300 text-center font-semibold text-[#999] hover:bg-[#2a2a2a] hover:border-[#3a3a3a] hover:text-[#ccc] active" id="notifyBtn">Notify Me</div>
                    <div class="option-btn flex-1 py-3 px-3 bg-[#1b1b1b] border-2 border-[#2a2a2a] rounded-lg cursor-pointer transition-all duration-300 text-center font-semibold text-[#999] hover:bg-[#2a2a2a] hover:border-[#3a3a3a] hover:text-[#ccc]" id="dontNotifyBtn">Don't Notify Me</div>
                </div>
            </div>

            <div class="form-group" id="fullnameGroup">
                <label for="fullname" class="block mb-2 text-[#ccc] font-semibold text-sm">Full Name</label>
                <input 
                    type="text" 
                    id="fullname" 
                    name="fullname" 
                    placeholder="Enter your full name"
                    class="w-full py-3 px-[15px] border-2 border-[#2a2a2a] rounded-lg text-[15px] transition-all duration-300 font-inherit bg-[#1b1b1b] text-white focus:outline-none focus:border-[#ffa31a] focus:shadow-[0_0_0_3px_rgba(255,163,26,0.15)]"
                >
                <div class="error-message text-[#ff4444] text-xs mt-1.5" id="nameError">Please enter your full name</div>
            </div>

            <div class="form-group" id="emailGroup">
                <label for="email" class="block mb-2 text-[#ccc] font-semibold text-sm">Email Address</label>
                <input 
                    type="email" 
                    id="email" 
                    name="email" 
                    placeholder="Enter your email address"
                    required
                    class="w-full py-3 px-[15px] border-2 border-[#2a2a2a] rounded-lg text-[15px] transition-all duration-300 font-inherit bg-[#1b1b1b] text-white focus:outline-none focus:border-[#ffa31a] focus:shadow-[0_0_0_3px_rgba(255,163,26,0.15)]"
                >
                <div class="error-message text-[#ff4444] text-xs mt-1.5" id="emailError">Please enter a valid email address</div>
            </div>

            <div class="form-group" id="userTypeGroup">
                <label class="block mb-2 text-[#ccc] font-semibold text-sm">I am a:</label>
                <div class="radio-group flex flex-col sm:flex-row gap-3 sm:gap-5 mt-2.5">
                    <div class="radio-option flex items-center cursor-pointer">
                        <input 
                            type="radio" 
                            id="student" 
                            name="userType" 
                            value="student"
                            class="w-[18px] h-[18px] mr-2 cursor-pointer accent-[#ffa31a]"
                        >
                        <label for="student" class="m-0 cursor-pointer font-medium text-[#ccc]">Student</label>
                    </div>
                    <div class="radio-option flex items-center cursor-pointer">
                        <input 
                            type="radio" 
                            id="faculty" 
                            name="userType" 
                            value="faculty"
                            class="w-[18px] h-[18px] mr-2 cursor-pointer accent-[#ffa31a]"
                        >
                        <label for="faculty" class="m-0 cursor-pointer font-medium text-[#ccc]">Faculty</label>
                    </div>
                </div>
                <div class="error-message text-[#ff4444] text-xs mt-1.5" id="typeError">Please select student or faculty</div>
            </div>

            <button type="submit" id="submitBtn" class="w-full py-3.5 bg-[#ffa31a] text-black border-none rounded-lg text-base font-bold cursor-pointer transition-all duration-300 mt-2.5 hover:bg-[#ff9500] hover:-translate-y-0.5 hover:shadow-[0_10px_20px_rgba(255,163,26,0.3)] active:translate-y-0 disabled:opacity-60 disabled:cursor-not-allowed disabled:transform-none">Submit</button>
        </form>

        <div class="success-message bg-[#ffa31a] text-black py-[15px] px-4 rounded-lg text-center mt-5 hidden animate-slideIn font-semibold" id="successMessage">
            Thank you! You've been successfully registered.
        </div>

        <div class="error-alert bg-[#ff4444] text-white py-[15px] px-4 rounded-lg text-center mt-5 hidden animate-slideIn font-semibold" id="errorAlert">
            An error occurred. Please try again.
        </div>
    </div>

    <!-- Include Supabase JavaScript Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Initialize Supabase client
        const SUPABASE_URL = 'https://dqtictujkhxultwoaqaw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRxdGljdHVqa2h4dWx0d29hcWF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyOTU1MjksImV4cCI6MjA3Mzg3MTUyOX0.DsnJZ9ylCBlTeVp_KdgRq71cV0f7MojOfuWg1MVGS5I';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Get form and input elements
        const form = document.getElementById('notifyForm');
        const fullnameInput = document.getElementById('fullname');
        const emailInput = document.getElementById('email');
        const userTypeInputs = document.querySelectorAll('input[name="userType"]');
        const submitBtn = document.getElementById('submitBtn');
        const successMessage = document.getElementById('successMessage');
        const errorAlert = document.getElementById('errorAlert');

        // Get form groups
        const fullnameGroup = document.getElementById('fullnameGroup');
        const emailGroup = document.getElementById('emailGroup');
        const userTypeGroup = document.getElementById('userTypeGroup');

        // Get option buttons
        const notifyBtn = document.getElementById('notifyBtn');
        const dontNotifyBtn = document.getElementById('dontNotifyBtn');

        // Get error message elements
        const nameError = document.getElementById('nameError');
        const emailError = document.getElementById('emailError');
        const typeError = document.getElementById('typeError');

        // Email validation regex pattern
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

        // Track current selection
        let currentSelection = 'notify';

        // Handle "Notify Me" button click
        notifyBtn.addEventListener('click', function() {
            currentSelection = 'notify';
            notifyBtn.classList.add('active');
            dontNotifyBtn.classList.remove('active');
            
            // Show all fields
            fullnameGroup.classList.remove('hidden');
            userTypeGroup.classList.remove('hidden');
            
            // Make fields required
            fullnameInput.setAttribute('required', 'required');
        });

        // Handle "Don't Notify Me" button click
        dontNotifyBtn.addEventListener('click', function() {
            currentSelection = 'dontNotify';
            dontNotifyBtn.classList.add('active');
            notifyBtn.classList.remove('active');
            
            // Hide name and user type fields
            fullnameGroup.classList.add('hidden');
            userTypeGroup.classList.add('hidden');
            
            // Remove required from hidden fields
            fullnameInput.removeAttribute('required');
            
            // Clear any errors on hidden fields
            fullnameInput.classList.remove('error');
            nameError.classList.remove('show');
            typeError.classList.remove('show');
            
            // Uncheck radio buttons
            userTypeInputs.forEach(input => input.checked = false);
        });

        // Real-time validation on input blur
        fullnameInput.addEventListener('blur', function() {
            if (currentSelection === 'notify') {
                validateFullName();
            }
        });

        emailInput.addEventListener('blur', function() {
            validateEmail();
        });

        // Validate full name
        function validateFullName() {
            const fullname = fullnameInput.value.trim();
            
            if (fullname === '') {
                fullnameInput.classList.add('error');
                nameError.classList.add('show');
                return false;
            } else {
                fullnameInput.classList.remove('error');
                nameError.classList.remove('show');
                return true;
            }
        }

        // Validate email address
        function validateEmail() {
            const email = emailInput.value.trim();
            
            if (email === '' || !emailPattern.test(email)) {
                emailInput.classList.add('error');
                emailError.classList.add('show');
                return false;
            } else {
                emailInput.classList.remove('error');
                emailError.classList.remove('show');
                return true;
            }
        }

        // Validate user type selection
        function validateUserType() {
            const isSelected = Array.from(userTypeInputs).some(input => input.checked);
            
            if (!isSelected) {
                typeError.classList.add('show');
                return false;
            } else {
                typeError.classList.remove('show');
                return true;
            }
        }

        // Insert data into Supabase
        async function insertToSupabase(data) {
            try {
                const { data: result, error } = await supabaseClient
                    .from('notifications')
                    .insert([data]);

                if (error) {
                    console.error('Supabase error:', error);
                    return { success: false, error: error.message };
                }

                return { success: true, data: result };
            } catch (err) {
                console.error('Error inserting data:', err);
                return { success: false, error: err.message };
            }
        }

        // Delete data from Supabase by email
        async function deleteFromSupabase(email) {
            try {
                const { data: result, error } = await supabaseClient
                    .from('notifications')
                    .delete()
                    .eq('email', email)
                    .select();

                if (error) {
                    console.error('Supabase error:', error);
                    return { success: false, error: error.message };
                }

                // Check if any rows were deleted
                if (result && result.length > 0) {
                    return { success: true, data: result, deleted: true };
                } else {
                    return { success: true, data: result, deleted: false };
                }
            } catch (err) {
                console.error('Error deleting data:', err);
                return { success: false, error: err.message };
            }
        }

        // Form submission handler
        form.addEventListener('submit', async function(event) {
            event.preventDefault();
            
            // Hide previous messages
            successMessage.classList.remove('show');
            errorAlert.classList.remove('show');
            
            let isValid = true;
            
            if (currentSelection === 'notify') {
                // Validate all fields for "Notify Me"
                const isNameValid = validateFullName();
                const isEmailValid = validateEmail();
                const isTypeValid = validateUserType();
                
                isValid = isNameValid && isEmailValid && isTypeValid;
                
                if (isValid) {
                    // Prepare form data
                    const formData = {
                        notification_type: 'notify',
                        fullname: fullnameInput.value.trim(),
                        email: emailInput.value.trim(),
                        user_type: Array.from(userTypeInputs).find(input => input.checked).value,
                        created_at: new Date().toISOString()
                    };
                    
                    // Disable submit button during submission
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Submitting...';
                    
                    // Insert data to Supabase
                    const result = await insertToSupabase(formData);
                    
                    // Re-enable submit button
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit';
                    
                    if (result.success) {
                        successMessage.textContent = "Thank you! You've been successfully registered for notifications.";
                        successMessage.classList.add('show');
                        
                        // Reset form after 3 seconds
                        setTimeout(function() {
                            form.reset();
                            successMessage.classList.remove('show');
                            
                            // Reset to default "Notify Me" state
                            currentSelection = 'notify';
                            notifyBtn.classList.add('active');
                            dontNotifyBtn.classList.remove('active');
                            fullnameGroup.classList.remove('hidden');
                            userTypeGroup.classList.remove('hidden');
                            fullnameInput.setAttribute('required', 'required');
                        }, 3000);
                    } else {
                        errorAlert.textContent = `Error: ${result.error}`;
                        errorAlert.classList.add('show');
                        
                        setTimeout(function() {
                            errorAlert.classList.remove('show');
                        }, 5000);
                    }
                }
            } else {
                // Validate only email for "Don't Notify Me"
                const isEmailValid = validateEmail();
                
                isValid = isEmailValid;
                
                if (isValid) {
                    const email = emailInput.value.trim();
                    
                    // Disable submit button during submission
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Processing...';
                    
                    // Delete data from Supabase
                    const result = await deleteFromSupabase(email);
                    
                    // Re-enable submit button
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit';
                    
                    if (result.success) {
                        if (result.deleted) {
                            successMessage.textContent = "Your email has been removed from notifications.";
                        } else {
                            successMessage.textContent = "No matching email found in our records.";
                        }
                        successMessage.classList.add('show');
                        
                        // Reset form after 3 seconds
                        setTimeout(function() {
                            form.reset();
                            successMessage.classList.remove('show');
                            
                            // Reset to default "Notify Me" state
                            currentSelection = 'notify';
                            notifyBtn.classList.add('active');
                            dontNotifyBtn.classList.remove('active');
                            fullnameGroup.classList.remove('hidden');
                            userTypeGroup.classList.remove('hidden');
                            fullnameInput.setAttribute('required', 'required');
                        }, 3000);
                    } else {
                        errorAlert.textContent = `Error: ${result.error}`;
                        errorAlert.classList.add('show');
                        
                        setTimeout(function() {
                            errorAlert.classList.remove('show');
                        }, 5000);
                    }
                }
            }
        });

        // Remove error styling when user starts typing
        fullnameInput.addEventListener('input', function() {
            if (fullnameInput.value.trim() !== '') {
                fullnameInput.classList.remove('error');
                nameError.classList.remove('show');
            }
        });

        emailInput.addEventListener('input', function() {
            if (emailInput.value.trim() !== '') {
                emailInput.classList.remove('error');
                emailError.classList.remove('show');
            }
        });

        userTypeInputs.forEach(input => {
            input.addEventListener('change', function() {
                typeError.classList.remove('show');
            });
        });
    </script>
</body>
</html>
