<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Forgot Password | Communication Hub</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="susi.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'ph-orange': '#ffa31a',
            'ph-orange-hover': '#ff9500',
            'ph-dark': '#1b1b1b',
            'ph-black': '#000000',
            'ph-gray': '#2a2a2a',
            'ph-light-gray': '#999999',
          }
        }
      }
    }
  </script>
  <style>
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>
<body class="bg-ph-dark flex items-center justify-center min-h-screen p-4">

  <div class="bg-ph-black p-8 rounded-2xl shadow-2xl w-full max-w-md">
    
    <!-- Logo and Header -->
    <div class="text-center mb-6">
      <div class="mx-auto w-20 h-20 mb-4">
        <img src="CCSICTLOGOCROP.png" alt="Logo" class="w-full h-full rounded-full border-4 border-ph-orange shadow-lg shadow-ph-orange/50">
      </div>
      <h2 class="text-2xl sm:text-3xl font-bold text-ph-orange mb-2">Forgot Password</h2>
      <p class="text-ph-light-gray text-sm">Enter your registered email address</p>
    </div>

    <!-- Step 1: Email Form -->
    <form id="emailForm" class="space-y-4">
      <input type="email" id="emailInput" required placeholder="Email Address"
             class="w-full bg-ph-gray text-white px-4 py-3 rounded-lg border-2 border-ph-dark focus:outline-none focus:border-ph-orange focus:ring-4 focus:ring-ph-orange/30 transition-all">
      <button type="submit" id="sendOtpBtn"
              class="w-full bg-ph-orange hover:bg-ph-orange-hover font-bold text-black py-3 rounded-lg transition-all transform hover:-translate-y-1 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
              Send OTP Code
      </button>
    </form>

    <p id="emailMessage" class="text-sm text-center mt-4 min-h-[24px]"></p>

    <!-- Step 2: OTP Modal -->
    <div id="otpModal" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-50 p-4">
      <div class="bg-ph-gray p-6 sm:p-8 rounded-xl w-full max-w-sm text-center shadow-2xl">
        <h3 class="text-xl sm:text-2xl font-bold text-ph-orange mb-2">Verify OTP</h3>
        <p class="text-ph-light-gray text-sm mb-4">Enter the 6-digit code sent to your email</p>
        <input type="text" id="otpCode" maxlength="6" placeholder="000000"
               class="w-full px-4 py-3 mb-4 bg-ph-black text-white text-center text-2xl tracking-widest border-2 border-ph-dark rounded-lg focus:outline-none focus:border-ph-orange focus:ring-4 focus:ring-ph-orange/30 transition-all">
        <button id="verifyOtpBtn"
                class="w-full bg-ph-orange hover:bg-ph-orange-hover font-bold text-black py-3 rounded-lg transition-all transform hover:-translate-y-1 hover:shadow-lg">
                Verify Code
        </button>
        <p id="otpMessage" class="text-sm mt-3 min-h-[20px]"></p>
      </div>
    </div>

    <!-- Step 3: New Password Form -->
    <form id="resetForm" class="hidden mt-6 space-y-4">
      <div class="relative">
        <input type="password" id="newPassword" required placeholder="Enter New Password"
               class="w-full bg-ph-gray text-white px-4 py-3 rounded-lg border-2 border-ph-dark focus:outline-none focus:border-ph-orange focus:ring-4 focus:ring-ph-orange/30 transition-all">
      </div>
      <button type="submit"
              class="w-full bg-ph-orange hover:bg-ph-orange-hover font-bold text-black py-3 rounded-lg transition-all transform hover:-translate-y-1 hover:shadow-lg">
              Update Password
      </button>
      <p id="resetMessage" class="text-sm text-center mt-4 min-h-[24px]"></p>
    </form>

    <!-- Back to Login -->
    <div class="mt-6">
      <a href="faculty_login.html" class="inline-flex items-center gap-2 text-sm text-ph-light-gray hover:text-ph-orange transition-colors duration-300">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back to Login
      </a>
    </div>

  </div>
<script>
  // Initialize EmailJS
  (function() {
    emailjs.init('tbAldsuV0ZauR0pr0');
  })();

  const emailForm = document.getElementById('emailForm');
  const otpModal = document.getElementById('otpModal');
  const resetForm = document.getElementById('resetForm');
  const emailInput = document.getElementById('emailInput');
  const otpCode = document.getElementById('otpCode');
  const newPasswordInput = document.getElementById('newPassword');
  const emailMessage = document.getElementById('emailMessage');
  const otpMessage = document.getElementById('otpMessage');
  const resetMessage = document.getElementById('resetMessage');
  const sendOtpBtn = document.getElementById('sendOtpBtn');

  let currentEmail = '';
  let generatedOtp = '';

  // Step 1: Check email and send OTP
  emailForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    currentEmail = emailInput.value.trim();
    emailMessage.textContent = 'Checking email...';
    emailMessage.classList.remove('text-red-500', 'text-green-500');
    emailMessage.classList.add('text-ph-light-gray');
    sendOtpBtn.disabled = true;

    try {
      // Check if email exists in members table
      const { data: userData, error } = await supabaseClient
        .from('members')
        .select('email')
        .eq('email', currentEmail)
        .maybeSingle();

      if (error) {
        console.error('Supabase error:', error);
        emailMessage.textContent = '✗ Error checking email. Please try again.';
        emailMessage.classList.add('text-red-500');
        sendOtpBtn.disabled = false;
        return;
      }

      if (!userData) {
        emailMessage.textContent = '✗ No account found with this email address.';
        emailMessage.classList.add('text-red-500');
        sendOtpBtn.disabled = false;
        return;
      }

      // Generate 6-digit OTP
      generatedOtp = String(Math.floor(100000 + Math.random() * 900000));
      
      emailMessage.textContent = 'Sending OTP to your email...';

      // Send OTP via EmailJS with detailed error logging
      const templateParams = {
        to_email: currentEmail,
        otp_code: generatedOtp,
        reply_to: currentEmail
      };

      console.log('Sending email with params:', templateParams);

      const response = await emailjs.send(
        'service_zlsxlxc',
        'template_n48tvic',
        templateParams
      );

      console.log('EmailJS response:', response);

      emailMessage.textContent = '✓ OTP sent successfully! Check your email.';
      emailMessage.classList.remove('text-red-500');
      emailMessage.classList.add('text-green-500');
      
      // Show OTP modal
      otpModal.classList.remove('hidden');
      
    } catch (error) {
      console.error('Full error details:', error);
      console.error('Error status:', error.status);
      console.error('Error text:', error.text);
      
      let errorMessage = '✗ Failed to send OTP. ';
      if (error.text) {
        errorMessage += error.text;
      } else {
        errorMessage += 'Please check console for details.';
      }
      
      emailMessage.textContent = errorMessage;
      emailMessage.classList.add('text-red-500');
    } finally {
      sendOtpBtn.disabled = false;
    }
  });

  // Step 2: Verify OTP
  document.getElementById('verifyOtpBtn').addEventListener('click', () => {
    const enteredOtp = otpCode.value.trim();
    otpMessage.textContent = 'Verifying...';
    otpMessage.classList.remove('text-red-500', 'text-green-500');
    otpMessage.classList.add('text-ph-light-gray');

    if (enteredOtp === generatedOtp) {
      otpMessage.textContent = '✓ OTP verified successfully!';
      otpMessage.classList.add('text-green-500');
      
      setTimeout(() => {
        otpModal.classList.add('hidden');
        resetForm.classList.remove('hidden');
        emailForm.classList.add('hidden');
      }, 1000);
    } else {
      otpMessage.textContent = '✗ Invalid OTP code. Please try again.';
      otpMessage.classList.add('text-red-500');
      otpCode.value = '';
      otpCode.focus();
    }
  });

  // Step 3: Update password
  resetForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const newPassword = newPasswordInput.value.trim();
    resetMessage.textContent = 'Updating password...';
    resetMessage.classList.remove('text-red-500', 'text-green-500');
    resetMessage.classList.add('text-ph-light-gray');

    try {
      const { error } = await supabaseClient
        .from('members')
        .update({ password: newPassword })
        .eq('email', currentEmail);

      if (error) {
        resetMessage.textContent = '✗ Failed to update password. Please try again.';
        resetMessage.classList.add('text-red-500');
        return;
      }

      resetMessage.textContent = '✓ Password updated successfully! Redirecting...';
      resetMessage.classList.add('text-green-500');
      
      setTimeout(() => {
        window.location.href = 'faculty_Dashboard.html';
      }, 2000);

    } catch (error) {
      resetMessage.textContent = '✗ An error occurred. Please try again.';
      resetMessage.classList.add('text-red-500');
      console.error('Error:', error);
    }
  });

  // Allow only numbers in OTP input
  otpCode.addEventListener('input', (e) => {
    e.target.value = e.target.value.replace(/[^0-9]/g, '');
  });
</script>
</body>
</html>

